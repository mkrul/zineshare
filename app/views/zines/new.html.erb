<div class="page-header">
  <div class="header-content">
    <h1 class="page-title">Upload Your Zine</h1>
    <p class="page-subtitle">Share your creative work with the community</p>
  </div>
</div>

<div class="form-container">
  <% if @zine.errors.any? %>
    <div class="error-messages">
      <h4><%= pluralize(@zine.errors.count, "error") %> prohibited this zine from being saved:</h4>
      <ul>
        <% @zine.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= form_with model: @zine, local: true, multipart: true do |form| %>
    <div class="form-group">
      <%= form.label :title, "Title", class: "form-label" %>
      <%= form.text_field :title, class: "form-control", placeholder: "Enter the zine title" %>
    </div>

    <div class="form-group">
      <%= form.label :created_by, "Created by", class: "form-label" %>
      <%= form.text_field :created_by, class: "form-control", placeholder: "Your name or handle" %>
    </div>

    <div class="form-group">
      <%= form.label :category_id, "Category", class: "form-label" %>
      <%= form.select :category_id,
          options_from_collection_for_select(@categories, :id, :name, @zine.category_id),
          { prompt: "Select a category" },
          { class: "form-control form-select" } %>
    </div>

    <div class="field">
      <%= form.label :pdf_file, "PDF File", class: "field-label" %>
      <div class="file-upload-area">
        <label for="zine_pdf_file" class="file-upload-label">
          <%= form.file_field :pdf_file,
                              accept: "application/pdf",
                              required: true,
                              class: "file-input",
                              id: "zine_pdf_file",
                              onchange: "updateFileDisplay(this)" %>
          <div class="file-upload-text">
            <strong>Choose PDF file</strong> or drag it here
            <br>
            <small>Must be exactly 1224Ã—1584 pixels, max 10MB</small>
          </div>
        </label>
      </div>

      <!-- Simple file display -->
      <div id="file-display" class="file-display" style="display: none;">
        <div class="file-info">
          <span class="file-icon">ðŸ“„</span>
          <span id="file-name"></span>
          <button type="button" onclick="clearFile(event)" class="remove-btn">âœ•</button>
        </div>
      </div>
    </div>

    <small class="form-text text-muted">
      Your PDF will be processed to remove metadata and validated for the correct dimensions and file size.
    </small>

    <div class="form-actions">
      <%= form.submit "Upload Zine", class: "btn btn-primary", id: "upload-btn" %>
      <%= link_to "Cancel", root_path, class: "btn btn-secondary", id: "cancel-btn" %>
    </div>
  <% end %>
</div>



<script>
// Simple file display functions
function updateFileDisplay(input) {
  const fileDisplay = document.getElementById('file-display');
  const fileName = document.getElementById('file-name');

  if (input.files && input.files.length > 0) {
    const file = input.files[0];
    if (fileDisplay && fileName) {
      fileName.textContent = file.name;
      fileDisplay.style.display = 'block';
    }
  } else {
    if (fileDisplay) {
      fileDisplay.style.display = 'none';
    }
  }
}

function clearFile(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }

  const fileInput = document.querySelector('input[type="file"]');
  const fileDisplay = document.getElementById('file-display');
  const fileLabel = document.querySelector('.file-upload-label');

  if (fileInput) {
    fileInput.value = '';
  }

  if (fileDisplay) {
    fileDisplay.style.display = 'none';
  }

  if (fileLabel) {
    fileLabel.classList.remove('has-file');
    const uploadText = fileLabel.querySelector('.file-upload-text');
    if (uploadText) {
      uploadText.innerHTML = `
        <strong>Choose PDF file</strong> or drag it here
        <br>
        <small>Must be exactly 1224Ã—1584 pixels, max 10MB</small>
      `;
    }
  }
}

// Main JavaScript
document.addEventListener('DOMContentLoaded', function() {

  const fileInput = document.querySelector('input[type="file"]');
  const fileLabel = document.querySelector('.file-upload-label');
  const form = document.querySelector('form');

  if (!fileInput || !fileLabel) {
    return;
  }

  // File selection via click
  fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      // Update the upload label
      fileLabel.classList.add('has-file');
      const uploadText = fileLabel.querySelector('.file-upload-text');
      if (uploadText) {
        uploadText.innerHTML = `
          <strong>âœ“ File Selected</strong>
          <br>
          <small>Click to change or see below</small>
        `;
      }
    } else {
      // Reset label if no file
      fileLabel.classList.remove('has-file');
      const uploadText = fileLabel.querySelector('.file-upload-text');
      if (uploadText) {
        uploadText.innerHTML = `
          <strong>Choose PDF file</strong> or drag it here
          <br>
          <small>Must be exactly 1224Ã—1584 pixels, max 10MB</small>
        `;
      }
    }
  });

  // Drag and drop functionality
  fileLabel.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.stopPropagation();
    fileLabel.classList.add('drag-over');
  });

  fileLabel.addEventListener('dragleave', function(e) {
    e.preventDefault();
    e.stopPropagation();
    fileLabel.classList.remove('drag-over');
  });

  fileLabel.addEventListener('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
    fileLabel.classList.remove('drag-over');

    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInput.files = files;
      // Trigger change event
      const changeEvent = new Event('change', { bubbles: true });
      fileInput.dispatchEvent(changeEvent);
    }
  });

  // Form submission
  if (form) {
    form.addEventListener('submit', function(e) {
      const fileInput = form.querySelector('input[type="file"]');

      if (!fileInput || !fileInput.files.length) {
        e.preventDefault();
        alert('Please select a PDF file before uploading.');
        return false;
      }

      // Validate required fields
      const title = form.querySelector('input[name="zine[title]"]');
      const createdBy = form.querySelector('input[name="zine[created_by]"]');
      const category = form.querySelector('select[name="zine[category_id]"]');

      if (!title || !title.value.trim()) {
        e.preventDefault();
        alert('Please enter a title for your zine.');
        return false;
      }

      if (!createdBy || !createdBy.value.trim()) {
        e.preventDefault();
        alert('Please enter who created this zine.');
        return false;
      }

      if (!category || !category.value) {
        e.preventDefault();
        alert('Please select a category for your zine.');
        return false;
      }

      // Show button spinner
      showButtonSpinner();
    });
  }
});

// Button spinner function
function showButtonSpinner() {
  const uploadBtn = document.getElementById('upload-btn');

  if (uploadBtn) {
    uploadBtn.disabled = true;
    uploadBtn.classList.add('btn-disabled');
    uploadBtn.innerHTML = '<span class="btn-spinner"></span>Uploading...';
  }
}
</script>
